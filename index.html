

  /* ===== Bilingual text helpers ===== */
  .bi{display:inline-flex;flex-direction:column;line-height:1.15}
  .bi .en{font-weight:800;font-size:13px}
  .bi .ar{font-weight:700;font-size:11px;opacity:.92;direction:rtl}

  .tabs{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
  .tab{
    padding:10px 12px;border-radius:14px;border:1px solid transparent;
    cursor:pointer;font-weight:900;font-size:13px;
    background:var(--p6);
  }
  .tab[data-col="1"]{background:var(--p2)}
  .tab[data-col="2"]{background:var(--p3)}
  .tab[data-col="3"]{background:var(--p4)}
  .tab[data-col="4"]{background:var(--p1)}
  .tab[data-col="5"]{background:var(--p5)}
  .tab.active{outline:2px solid rgba(17,24,39,.18)}

  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:980px){ .grid.two{grid-template-columns:1.15fr .85fr} }

  .card{
    background:rgba(255,255,255,.92);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
  }
  .card h2{margin:0 0 10px 0;font-size:14px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{flex:1;min-width:170px}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 0}
  input, select, textarea{
    width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--line);
    background:#fff;color:var(--ink);outline:none;
  }
  textarea{min-height:90px;resize:vertical}

  .btn{
    padding:11px 12px;border-radius:14px;border:1px solid transparent;
    cursor:pointer;font-weight:950;
    background:var(--p6);
  }
  .btn.pink{background:var(--p1)}
  .btn.blue{background:var(--p2)}
  .btn.purple{background:var(--p3)}
  .btn.mint{background:var(--p4)}
  .btn.butter{background:var(--p5)}
  .btn.dark{background:#111827;color:#fff}

  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border:1px solid var(--line);
    border-radius:999px;background:rgba(255,255,255,.85);font-size:12px;color:var(--muted)
  }
  .tiny{font-size:12px;color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:12px 0}

  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
  td{
    background:rgba(255,255,255,.92);
    border:1px solid var(--line);
    padding:10px;border-left:none;border-right:none;
  }
  tr td:first-child{border-left:1px solid var(--line);border-radius:14px 0 0 14px}
  tr td:last-child{border-right:1px solid var(--line);border-radius:0 14px 14px 0}
  .right{text-align:right}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:18px;background:#111827;color:#fff;
    padding:10px 12px;border-radius:14px;opacity:0;pointer-events:none;
    transition:.25s;z-index:99;font-size:13px
  }
  .toast.show{opacity:1}
  .tag{
    display:inline-flex;gap:6px;align-items:center;
    font-size:12px;border-radius:999px;padding:7px 10px;border:1px solid var(--line);
    background:rgba(17,24,39,.04)
  }
  .tag.ok{border-color:rgba(22,163,74,.30);background:rgba(22,163,74,.10)}
  .tag.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
  .tag.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}

  .flex{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .items{display:grid;gap:10px}
  .item{
    border:1px solid var(--line);
    border-radius:16px;padding:10px;background:rgba(255,255,255,.88)
  }
  .itemhead{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .itemname{font-weight:950}
  .muted{color:var(--muted)}
  .kpi{display:grid;gap:10px}
  @media(min-width:980px){ .kpi{grid-template-columns:repeat(3,1fr)} }
  .kpi .box{
    border:1px solid var(--line);border-radius:18px;padding:12px;background:rgba(255,255,255,.88)
  }
  .box .v{font-size:20px;font-weight:950}
  .box .t{font-size:12px;color:var(--muted)}
  .smallbtn{padding:9px 10px;border-radius:12px}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo">BH</div>
      <div>
        <h1>BH â€” Invoices & Reports</h1>
        <p>Arabic + English â€¢ Pastel UI â€¢ LocalStorage â€¢ WhatsApp â€¢ Fixed Commission 3%</p>
      </div>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>

  <!-- PAGES -->
  <div id="page-invoice" class="page">
    <div class="grid two">
      <div class="card">
        <div class="flex">
          <h2><span class="bi"><span class="en">Create Invoice</span><span class="ar">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</span></span></h2>
          <div class="row">
            <span class="pill"><span class="bi"><span class="en">Today</span><span class="ar">Ø§Ù„ÙŠÙˆÙ…</span></span>: <span class="mono" id="todayStr"></span></span>
            <span class="pill"><span class="bi"><span class="en">Auto Kuwait phone</span><span class="ar">ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„ÙƒÙˆÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span></span></span>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label><span class="bi"><span class="en">Customer Phone (Kuwait only)</span><span class="ar">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙƒÙˆÙŠØªÙŠ ÙÙ‚Ø·)</span></span></label>
            <input id="custPhone" inputmode="numeric" placeholder="51234567 Ø£Ùˆ +96551234567"/>
            <div class="tiny" id="phoneHint"></div>
          </div>

          <div class="field" style="min-width:260px">
            <label><span class="bi"><span class="en">Staff Picker (multi)</span><span class="ar">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª (Ù…ØªØ¹Ø¯Ø¯)</span></span></label>
            <select id="staffPick" multiple size="6"></select>
            <div class="tiny"><span class="bi"><span class="en">Select multiple if shared.</span><span class="ar">Ø§Ø®ØªØ§Ø±ÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆØ¸ÙØ© Ø¹Ù†Ø¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø®Ø¯Ù…Ø©.</span></span></div>
          </div>

          <div class="field" style="min-width:220px">
            <label><span class="bi"><span class="en">Quick Actions</span><span class="ar">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</span></span></label>
            <div class="row">
              <button class="btn mint" id="pkgMaskBtn" title="Sell package if not active / otherwise use a session">
                <span class="bi"><span class="en">Package Mask (5Ã—)</span><span class="ar">Ø¨ÙƒØ¬ Ù…Ø§Ø³Ùƒ (Ù¥ Ù…Ø±Ø§Øª)</span></span>
              </button>
              <button class="btn blue" id="addItemBtn">
                <span class="bi"><span class="en">Add Selected Service</span><span class="ar">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</span></span>
              </button>
            </div>
            <div class="tiny"><span class="bi">
              <span class="en">Package: sell 15 KD once, sessions 0 KD with staff.</span>
              <span class="ar">Ø§Ù„Ø¨ÙƒØ¬: Ø¨ÙŠØ¹ Ù¡Ù¥ Ø¯Ùƒ Ù…Ø±Ø©ØŒ ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª Ù  Ø¯Ùƒ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙØ©.</span>
            </span></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field" style="min-width:260px">
            <label><span class="bi"><span class="en">Category</span><span class="ar">Ø§Ù„Ù‚Ø³Ù…</span></span></label>
            <select id="catSel"></select>
          </div>
          <div class="field" style="min-width:360px">
            <label><span class="bi"><span class="en">Service</span><span class="ar">Ø§Ù„Ø®Ø¯Ù…Ø©</span></span></label>
            <select id="svcSel"></select>
          </div>
          <div class="field" style="max-width:120px">
            <label><span class="bi"><span class="en">Qty</span><span class="ar">Ø§Ù„Ø¹Ø¯Ø¯</span></span></label>
            <input id="qtySel" type="number" min="1" value="1"/>
          </div>
        </div>

        <div class="hr"></div>

        <h2><span class="bi"><span class="en">Invoice Items</span><span class="ar">Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span></span></h2>
        <div class="items" id="items"></div>

        <div class="hr"></div>

        <div class="flex">
          <div class="row">
            <span class="tag" id="subTag">Package: â€”</span>
            <span class="tag" id="cashboxTag">Cashbox: OK</span>
          </div>
          <div class="row">
            <div class="pill"><span class="bi"><span class="en">Total</span><span class="ar">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span></span>: <b id="invTotal">0.000</b> KD</div>
            <button class="btn pink" id="clearInvBtn"><span class="bi"><span class="en">Clear</span><span class="ar">Ù…Ø³Ø­</span></span></button>
            <button class="btn dark" id="saveInvBtn"><span class="bi"><span class="en">Save + WhatsApp</span><span class="ar">Ø­ÙØ¸ + ÙˆØ§ØªØ³Ø§Ø¨</span></span></button>
          </div>
        </div>

        <div class="tiny">
          <span class="bi">
            <span class="en">WhatsApp message is short: services + total + â€œØ´ÙƒØ±Ø§ Ù„Ø²ÙŠØ§Ø±Ø© ØµØ§Ù„ÙˆÙ† bhâ€.</span>
            <span class="ar">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù‚ØµÙŠØ±Ø©: Ø§Ù„Ø®Ø¯Ù…Ø§Øª + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ + â€œØ´ÙƒØ±Ø§ Ù„Ø²ÙŠØ§Ø±Ø© ØµØ§Ù„ÙˆÙ† bhâ€.</span>
          </span>
        </div>
      </div>

      <div class="card">
        <div class="flex">
          <h2><span class="bi"><span class="en">Settings</span><span class="ar">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></span></h2>
          <span class="pill"><span class="bi"><span class="en">Saved locally</span><span class="ar">Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ</span></span></span>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label><span class="bi"><span class="en">Manager WhatsApp (Kuwait)</span><span class="ar">ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±Ø© (ÙƒÙˆÙŠØªÙŠ)</span></span></label>
            <input id="mgrPhone" inputmode="numeric" placeholder="69977533"/>
            <div class="tiny"><span class="bi"><span class="en">Used for Daily + Monthly reports.</span><span class="ar">ÙŠØ³ØªØ®Ø¯Ù… Ù„ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ + Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø±.</span></span></div>
          </div>
          <div class="field" style="max-width:220px">
            <label><span class="bi"><span class="en">Daily Target (only for display)</span><span class="ar">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)</span></span></label>
            <input id="target10" type="number" min="1" value="10"/>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn butter" id="backupBtn"><span class="bi"><span class="en">Backup</span><span class="ar">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span></span></button>
          <button class="btn purple" id="restoreBtn"><span class="bi"><span class="en">Restore</span><span class="ar">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</span></span></button>
          <button class="btn pink" id="wipeAllBtn"><span class="bi"><span class="en">Wipe ALL</span><span class="ar">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</span></span></button>
        </div>

        <div class="tiny" style="margin-top:8px">
          <span class="bi">
            <span class="en">Backup recommended. Restore overwrites current data.</span>
            <span class="ar">Ù…ÙØ¶Ù„ ØªØ³ÙˆÙŠÙ† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</span>
          </span>
        </div>

        <div class="hr"></div>
        <div class="tag ok">
          <span class="bi">
            <span class="en">Commission: Fixed 3% (Hidden)</span>
            <span class="ar">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨ØªØ© Ù£Ùª (Ù…Ø®ÙÙŠØ©)</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div id="page-today" class="page" style="display:none">
    <div class="card">
      <div class="flex">
        <h2><span class="bi"><span class="en">Today Invoices</span><span class="ar">ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…</span></span></h2>
        <div class="row">
          <button class="btn blue" id="refreshTodayBtn"><span class="bi"><span class="en">Refresh</span><span class="ar">ØªØ­Ø¯ÙŠØ«</span></span></button>
          <button class="btn butter" id="printTodayBtn"><span class="bi"><span class="en">PDF (Print)</span><span class="ar">PDF (Ø·Ø¨Ø§Ø¹Ø©)</span></span></button>
        </div>
      </div>
      <div class="tiny"><span class="bi"><span class="en">Each invoice has WhatsApp resend.</span><span class="ar">ÙƒÙ„ ÙØ§ØªÙˆØ±Ø© ÙÙŠÙ‡Ø§ Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨.</span></span></div>
      <div class="hr"></div>
      <div id="todayList"></div>
    </div>
  </div>

  <div id="page-stats" class="page" style="display:none">
    <div class="card">
      <div class="flex">
        <h2><span class="bi"><span class="en">Statistics (Daily)</span><span class="ar">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span></span></h2>
        <button class="btn mint" id="refreshStatsBtn"><span class="bi"><span class="en">Refresh Statistics</span><span class="ar">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©</span></span></button>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="v" id="kpiIncome">0.000</div><div class="t">Income â€¢ Ø§Ù„Ø¯Ø®Ù„</div></div>
        <div class="box"><div class="v" id="kpiInv">0</div><div class="t">Invoices â€¢ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div></div>
        <div class="box"><div class="v" id="kpiServices">0</div><div class="t">Services Qty â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div></div>
      </div>

      <div class="hr"></div>

      <div class="grid two">
        <div class="card" style="box-shadow:none;background:transparent;border:none;padding:0">
          <h2><span class="bi"><span class="en">Services Count</span><span class="ar">Ø¹Ø¯Ø¯ ÙƒÙ„ Ø®Ø¯Ù…Ø©</span></span></h2>
          <div id="svcCounts"></div>
        </div>
        <div class="card" style="box-shadow:none;background:transparent;border:none;padding:0">
          <h2><span class="bi"><span class="en">Staff Count</span><span class="ar">Ø¹Ø¯Ø¯ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ©</span></span></h2>
          <div id="staffCounts"></div>
          <div class="hr"></div>
          <div class="tag ok">
            <span class="bi">
              <span class="en">Commission is calculated in reports (Fixed 3%).</span>
              <span class="ar">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ØªÙØ­Ø³Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø«Ø§Ø¨ØªØ© Ù£Ùª).</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="page-daily" class="page" style="display:none">
    <div class="card">
      <div class="flex">
        <h2><span class="bi"><span class="en">Daily Report (Manager)</span><span class="ar">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ (Ù„Ù„Ù…Ø¯ÙŠØ±Ø©)</span></span></h2>
        <div class="row">
          <button class="btn purple" id="buildDailyBtn"><span class="bi"><span class="en">Build</span><span class="ar">Ø¥Ù†Ø´Ø§Ø¡</span></span></button>
          <button class="btn mint" id="sendDailyBtn"><span class="bi"><span class="en">Send WhatsApp</span><span class="ar">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</span></span></button>
          <button class="btn butter" id="pdfDailyBtn"><span class="bi"><span class="en">PDF (Print)</span><span class="ar">PDF (Ø·Ø¨Ø§Ø¹Ø©)</span></span></button>
        </div>
      </div>
      <div class="tiny">
        <span class="bi">
          <span class="en">Includes invoices + staff sales + commission (Fixed 3%).</span>
          <span class="ar">ÙŠØ´Ù…Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± + Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª + Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø«Ø§Ø¨ØªØ© Ù£Ùª).</span>
        </span>
      </div>
      <div class="hr"></div>
      <div id="dailyPreview"></div>
    </div>
  </div>

  <div id="page-monthly" class="page" style="display:none">
    <div class="card">
      <div class="flex">
        <h2><span class="bi"><span class="en">Monthly Commission</span><span class="ar">Ø¹Ù…ÙˆÙ„Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</span></span></h2>
        <div class="row">
          <div class="field" style="min-width:220px">
            <label><span class="bi"><span class="en">Month</span><span class="ar">Ø§Ù„Ø´Ù‡Ø±</span></span></label>
            <input id="monthSel" type="month"/>
          </div>
          <button class="btn purple" id="buildMonthlyBtn"><span class="bi"><span class="en">Build</span><span class="ar">Ø¥Ù†Ø´Ø§Ø¡</span></span></button>
          <button class="btn mint" id="sendMonthlyBtn"><span class="bi"><span class="en">Send WhatsApp</span><span class="ar">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</span></span></button>
          <button class="btn butter" id="pdfMonthlyBtn"><span class="bi"><span class="en">PDF (Print)</span><span class="ar">PDF (Ø·Ø¨Ø§Ø¹Ø©)</span></span></button>
        </div>
      </div>
      <div class="tiny">
        <span class="bi">
          <span class="en">Commission System: Fixed 3% on total staff sales.</span>
          <span class="ar">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨Øª Ù£Ùª Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ©.</span>
        </span>
      </div>
      <div class="hr"></div>
      <div id="monthlyPreview"></div>
    </div>
  </div>

  <div id="page-manage" class="page" style="display:none">
    <div class="grid two">
      <div class="card">
        <div class="flex">
          <h2><span class="bi"><span class="en">Manage Services</span><span class="ar">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span></span></h2>
          <button class="btn blue" id="addSvcOpenBtn"><span class="bi"><span class="en">Add Service</span><span class="ar">Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</span></span></button>
        </div>
        <div class="hr"></div>
        <div id="manageServices"></div>
      </div>

      <div class="card">
        <div class="flex">
          <h2><span class="bi"><span class="en">Manage Staff</span><span class="ar">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª</span></span></h2>
          <button class="btn blue" id="addStaffOpenBtn"><span class="bi"><span class="en">Add Staff</span><span class="ar">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙØ©</span></span></button>
        </div>
        <div class="hr"></div>
        <div id="manageStaff"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* =========================
   FIXED COMMISSION
   ========================= */
const FIXED_COMMISSION_PCT = 3; // ğŸ”’ Ø«Ø§Ø¨ØªØ© 3%

/* =========================
   Storage keys
   ========================= */
const K = {
  services: "bh_services_v3_fixed",
  staff: "bh_staff_v3_fixed",
  invoices: "bh_invoices_v3_fixed",
  subs: "bh_subs_v3_fixed",
  settings: "bh_settings_v3_fixed",
  backup: "bh_autobackup_v3_fixed"
};

const $ = (id)=>document.getElementById(id);
const todayKey = ()=> new Date().toISOString().slice(0,10);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"),1600);
}
function fmtKD(n){
  const x = Math.round((Number(n)||0)*1000)/1000;
  return x.toFixed(3);
}
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

/* ===== Kuwait Phone Cleaner ===== */
function cleanKuwaitPhone(raw){
  let s = (raw||"").toString().trim();
  if(!s) return {ok:false, msg:"Ø§ÙƒØªØ¨ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ / Enter phone"};
  s = s.replace(/\s+/g,"");
  if(s.startsWith("+")) s = s.slice(1);
  if(s.startsWith("00")) s = s.slice(2);
  if(/^965\d{8}$/.test(s)) return {ok:true, phone:s};
  if(/^\d{8}$/.test(s)) return {ok:true, phone:"965"+s};
  return {ok:false, msg:"Ø±Ù‚Ù… ØºÙŠØ± ÙƒÙˆÙŠØªÙŠ / Not Kuwait number"};
}
function openWA(phone965, text){
  const url = "https://wa.me/" + encodeURIComponent(phone965) + "?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

/* ===== Data load/save ===== */
function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch(e){ return fallback; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
  localStorage.setItem(K.backup, JSON.stringify({ts:Date.now()}));
}

/* ===== Defaults ===== */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function defaultServices(){
  return [
    {id:uid(), cat:"Spa", name:"Head Spa", price:10},
    {id:uid(), cat:"Spa", name:"Head Spa + Face", price:15},
    {id:uid(), cat:"Spa", name:"Massage", price:10},
    {id:uid(), cat:"Spa", name:"Massage 1/2", price:5},
    {id:uid(), cat:"Spa", name:"Hair Treatment + Head Spa", price:15},
    {id:uid(), cat:"Spa", name:"Hair Treatment + Head Spa + Face", price:20},

    {id:uid(), cat:"Steam Bath", name:"Bath", price:10},

    {id:uid(), cat:"Hair", name:"Blow Dry (3 KD)", price:3},
    {id:uid(), cat:"Hair", name:"Blow Dry (5 KD)", price:5},
    {id:uid(), cat:"Hair", name:"Wavy (5 KD)", price:5},
    {id:uid(), cat:"Hair", name:"Wavy (7 KD)", price:7},
    {id:uid(), cat:"Hair", name:"Hairstyle", price:10},
    {id:uid(), cat:"Hair", name:"Hair Wash", price:1},
    {id:uid(), cat:"Hair", name:"Treatment Hair Wash", price:3},
    {id:uid(), cat:"Hair", name:"Hair Mask", price:5},
    {id:uid(), cat:"Hair", name:"Hair Color Short", price:10},
    {id:uid(), cat:"Hair", name:"Hair Color Long", price:20},
    {id:uid(), cat:"Hair", name:"Hair Treatment", price:10},
    {id:uid(), cat:"Hair", name:"Hair Scrub", price:5},
    {id:uid(), cat:"Hair", name:"Retro", price:8},

    {id:uid(), cat:"Nails", name:"Pedicure", price:2.5},
    {id:uid(), cat:"Nails", name:"Manicure", price:2.5},
    {id:uid(), cat:"Nails", name:"Pedi / Mani", price:5},
    {id:uid(), cat:"Nails", name:"Spa Pedicure", price:5},
    {id:uid(), cat:"Nails", name:"Spa Manicure", price:5},
    {id:uid(), cat:"Nails", name:"Spa Pedi / Mani", price:10},
    {id:uid(), cat:"Nails", name:"Extensions 1", price:5},
    {id:uid(), cat:"Nails", name:"Extensions 2", price:10},
    {id:uid(), cat:"Nails", name:"Nail Polish (1 KD)", price:1},
    {id:uid(), cat:"Nails", name:"Nail Polish (2 KD)", price:2},
    {id:uid(), cat:"Nails", name:"French Polish", price:3},
    {id:uid(), cat:"Nails", name:"Cat Eye Polish", price:4},
    {id:uid(), cat:"Nails", name:"Chrome", price:4},
    {id:uid(), cat:"Nails", name:"Nail Art", price:5},
    {id:uid(), cat:"Nails", name:"Removal", price:6},

    {id:uid(), cat:"Hair Removal", name:"Upper Lip", price:1},
    {id:uid(), cat:"Hair Removal", name:"Eyebrow", price:1},
    {id:uid(), cat:"Hair Removal", name:"Face", price:3},
    {id:uid(), cat:"Hair Removal", name:"Body (5 KD)", price:5},
    {id:uid(), cat:"Hair Removal", name:"Body (10 KD)", price:10},

    {id:uid(), cat:"Other Services", name:"Makeup Simple", price:10},
    {id:uid(), cat:"Other Services", name:"Makeup", price:15},

    /* âœ… 3service requires 3+ staff */
    {id:uid(), cat:"Packages", name:"3service 15KD ashtrak", price:15, meta:{requiresStaffMin:3}},
  ];
}

function defaultStaff(){
  /* âœ… staff list as requested */
  return [
    {id:uid(), name:"kla"},
    {id:uid(), name:"bna"},
    {id:uid(), name:"meme"},
    {id:uid(), name:"sntsh"},
    {id:uid(), name:"nrml"},
    {id:uid(), name:"mlk"},
    {id:uid(), name:"indr"}
  ];
}

function defaultSettings(){
  /* commission is fixed & hidden, only store manager phone + optional target display */
  return { managerPhone:"96569977533", targetDaily:10 };
}

/* ===== State ===== */
let S = {
  services: loadJSON(K.services, null) || defaultServices(),
  staff: loadJSON(K.staff, null) || defaultStaff(),
  invoices: loadJSON(K.invoices, null) || [],
  subs: loadJSON(K.subs, null) || {},
  settings: Object.assign(defaultSettings(), loadJSON(K.settings, null)||{})
};
function persistAll(){
  saveJSON(K.services, S.services);
  saveJSON(K.staff, S.staff);
  saveJSON(K.invoices, S.invoices);
  saveJSON(K.subs, S.subs);
  saveJSON(K.settings, S.settings);
}

/* =========================
   Tabs / Pages (bilingual)
   ========================= */
const PAGES = [
  {id:"invoice", en:"Invoice", ar:"ÙØ§ØªÙˆØ±Ø©"},
  {id:"today", en:"Today Invoices", ar:"ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…"},
  {id:"stats", en:"Statistics", ar:"Ø¥Ø­ØµØ§Ø¦ÙŠØ©"},
  {id:"daily", en:"Daily Report", ar:"ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ"},
  {id:"monthly", en:"Monthly Commission", ar:"Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø±"},
  {id:"manage", en:"Manage", ar:"Ø¥Ø¯Ø§Ø±Ø©"}
];

function setPage(id){
  for(const p of PAGES){
    $("page-"+p.id).style.display = (p.id===id) ? "" : "none";
    const b = document.querySelector(`[data-tab="${p.id}"]`);
    if(b) b.classList.toggle("active", p.id===id);
  }
  if(id==="today") renderToday();
  if(id==="stats") renderStats();
  if(id==="daily") $("dailyPreview").innerHTML = `<div class="tiny">Build / Ø¥Ù†Ø´Ø§Ø¡</div>`;
  if(id==="monthly") {
    if(!$("monthSel").value){
      const d=new Date(); $("monthSel").value = d.toISOString().slice(0,7);
    }
    $("monthlyPreview").innerHTML = `<div class="tiny">Choose month Ø«Ù… Build</div>`;
  }
  if(id==="manage"){ renderManageServices(); renderManageStaff(); }
}

function initTabs(){
  const cols = ["1","2","3","4","5","1"];
  $("tabs").innerHTML = PAGES.map((p,i)=>`
    <button class="tab" data-col="${cols[i%cols.length]}" data-tab="${p.id}">
      <span class="bi"><span class="en">${p.en}</span><span class="ar">${p.ar}</span></span>
    </button>
  `).join("");
  for(const p of PAGES){
    document.querySelector(`[data-tab="${p.id}"]`).onclick = ()=>setPage(p.id);
  }
}

/* =========================
   Invoice
   ========================= */
let inv = { phone:"", items:[] };

function resetInv(){
  inv = {phone:"", items:[]};
  $("custPhone").value="";
  $("qtySel").value=1;
  $("staffPick").selectedIndex=-1;
  renderItems();
  refreshSubTag();
  toast("ØªÙ… / Done");
}

function getSelectedStaffIds(){
  const sel = $("staffPick");
  const ids = [];
  for(const opt of sel.options){ if(opt.selected) ids.push(opt.value); }
  return ids;
}
function staffName(id){ return (S.staff.find(x=>x.id===id)||{}).name || "â€”"; }
function serviceById(id){ return S.services.find(x=>x.id===id); }

function addItemFromSelect(){
  const svcId = $("svcSel").value;
  const svc = serviceById(svcId);
  if(!svc){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ø®Ø¯Ù…Ø© / Pick service"); return; }

  const qty = Math.max(1, Number($("qtySel").value)||1);
  const staffIds = getSelectedStaffIds();

  const minStaff = svc?.meta?.requiresStaffMin || 0;
  if(minStaff && staffIds.length < minStaff){
    toast(`Ù„Ø§Ø²Ù… ${minStaff}+ Ù…ÙˆØ¸ÙØ§Øª / Need ${minStaff}+ staff`);
    return;
  }

  inv.items.push({
    id: uid(),
    refServiceId: svc.id,
    name: svc.name,
    price: Number(svc.price)||0,
    qty,
    staffIds: staffIds.slice(),
    meta: Object.assign({}, svc.meta||{}, {type:"normal"})
  });

  renderItems();
  toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© / Added");
}

function removeItem(itemId){
  inv.items = inv.items.filter(x=>x.id!==itemId);
  renderItems();
}
function invTotal(){
  return inv.items.reduce((a,it)=>a + (Number(it.price)||0) * (Number(it.qty)||1), 0);
}

function refreshSubTag(){
  const c = cleanKuwaitPhone($("custPhone").value);
  let tag = $("subTag");
  if(!c.ok){
    tag.className="tag";
    tag.textContent="Package: â€”";
    return;
  }
  const sub = S.subs[c.phone];
  if(sub && sub.active){
    const rem = Math.max(0, sub.max - sub.used);
    tag.className="tag ok";
    tag.textContent=`Package Mask: Used ${sub.used}/${sub.max} â€¢ Remaining ${rem}`;
  }else{
    tag.className="tag";
    tag.textContent="Package Mask: Not Active";
  }
}

function renderItems(){
  $("invTotal").textContent = fmtKD(invTotal());
  const box = $("items");
  if(inv.items.length===0){
    box.innerHTML = `<div class="tiny">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø¨Ø¹Ø¯ / No items yet</div>`;
    return;
  }
  box.innerHTML = inv.items.map(it=>{
    const staff = (it.staffIds||[]).map(staffName).join(", ") || "â€”";
    const flags=[];
    if(it.meta?.type==="sub_sale") flags.push(`<span class="tag warn">Package Sale</span>`);
    if(it.meta?.type==="sub_use") flags.push(`<span class="tag ok">Package Use â€¢ ${it.meta.used}/${it.meta.max} â€¢ Rem ${it.meta.remaining}</span>`);
    if(it.meta?.requiresStaffMin) flags.push(`<span class="tag">Min Staff: ${it.meta.requiresStaffMin}</span>`);
    return `
      <div class="item">
        <div class="itemhead">
          <div>
            <div class="itemname">${escapeHtml(it.name)}</div>
            <div class="tiny">Staff: <b>${escapeHtml(staff)}</b></div>
            ${flags.length? `<div class="row" style="margin-top:6px">${flags.join("")}</div>`:""}
          </div>
          <div class="right">
            <div><b>${fmtKD(it.price)}</b> KD Ã— <b>${it.qty}</b></div>
            <div class="tiny muted">Line: ${fmtKD((it.price||0)*(it.qty||1))} KD</div>
            <div class="row" style="justify-content:flex-end;margin-top:6px">
              <button class="btn pink smallbtn" onclick="removeItem('${it.id}')">
                <span class="bi"><span class="en">Remove</span><span class="ar">Ø­Ø°Ù</span></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");
}
window.removeItem = removeItem;

function ensurePhoneOrWarn(){
  const c = cleanKuwaitPhone($("custPhone").value);
  if(!c.ok){ toast("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­ / Invalid phone"); return null; }
  $("custPhone").value = c.phone;
  return c.phone;
}

/* ===== Package Mask Logic ===== */
function pkgMaskAction(){
  const phone = ensurePhoneOrWarn();
  if(!phone) return;

  let sub = S.subs[phone];
  if(!sub || !sub.active){
    sub = {active:true, max:5, used:0};
    S.subs[phone]=sub;

    inv.items.push({
      id:uid(),
      name:"Package Mask (5 sessions)",
      price:15,
      qty:1,
      staffIds:getSelectedStaffIds().slice(),
      meta:{type:"sub_sale", max:5}
    });

    persistAll();
    renderItems(); refreshSubTag();
    toast("ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø¨ÙƒØ¬ / Package sold");
    return;
  }

  const staffIds = getSelectedStaffIds();
  if(staffIds.length<1){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…ÙˆØ¸ÙØ© Ù„Ù„Ø¬Ù„Ø³Ø© / Select staff"); return; }

  sub.used = Math.min(sub.max, sub.used+1);
  const remaining = Math.max(0, sub.max - sub.used);

  inv.items.push({
    id:uid(),
    name:"Mask Session (Package Mask)",
    price:0,
    qty:1,
    staffIds:[staffIds[0]],
    meta:{type:"sub_use", used:sub.used, remaining, max:sub.max}
  });

  if(sub.used>=sub.max){
    sub.active=false; sub.used=0;
    toast("Ø¢Ø®Ø± Ø¬Ù„Ø³Ø© â€” ØªØµÙÙŠØ± / Reset");
  }else{
    toast(`Ø¬Ù„Ø³Ø© ${sub.used}/${sub.max}`);
  }

  S.subs[phone]=sub;
  persistAll();
  renderItems(); refreshSubTag();
}

/* ===== Save Invoice + WhatsApp ===== */
function saveInvoiceAndWA(){
  const phone = ensurePhoneOrWarn();
  if(!phone) return;
  if(inv.items.length===0){ toast("Ø£Ø¶ÙŠÙÙŠ Ø®Ø¯Ù…Ø© / Add item"); return; }

  for(const it of inv.items){
    const minStaff = it.meta?.requiresStaffMin || 0;
    if(minStaff && (it.staffIds||[]).length < minStaff){
      toast(`"${it.name}" Ù„Ø§Ø²Ù… ${minStaff}+ Ù…ÙˆØ¸ÙØ§Øª`);
      return;
    }
  }

  const record = {
    id: uid(),
    date: todayKey(),
    ts: Date.now(),
    phone,
    items: inv.items.map(x=>({
      name:x.name,
      price:Number(x.price)||0,
      qty:Number(x.qty)||1,
      staffIds:(x.staffIds||[]).slice(),
      meta:x.meta||{}
    })),
    total: invTotal()
  };

  S.invoices.push(record);
  persistAll();

  const lines = record.items.map(it=>{
    const q = it.qty||1;
    const p = it.price||0;
    if(p===0) return `â€¢ ${it.name} Ã—${q}`;
    return `â€¢ ${it.name} Ã—${q} = ${fmtKD(p*q)}KD`;
  });

  const msg =
`BH Invoice
Phone: ${phone}
${lines.join("\n")}
Total: ${fmtKD(record.total)} KD
Ø´ÙƒØ±Ø§ Ù„Ø²ÙŠØ§Ø±Ø© ØµØ§Ù„ÙˆÙ† bh`;

  openWA(phone, msg);
  resetInv();
}

/* ===== Reports / Stats ===== */
function invoicesByDate(d){ return S.invoices.filter(x=>x.date===d); }
function isPackageItem(it){ return it?.meta?.type==="sub_sale" || it?.meta?.type==="sub_use"; }

/* Daily stats with staff sales (commission is fixed in reports) */
function dayStats(dateStr){
  const invs = invoicesByDate(dateStr);
  let income=0, invCount=invs.length;

  const svcCounts={}, staffCounts={}, staffSales={};
  for(const st of S.staff){ staffCounts[st.id]=0; staffSales[st.id]=0; }

  for(const inv of invs){
    income += Number(inv.total)||0;
    for(const it of inv.items){
      const qty = Number(it.qty)||1;
      svcCounts[it.name]=(svcCounts[it.name]||0)+qty;

      const staffIds=(it.staffIds||[]).filter(Boolean);
      if(staffIds.length){
        for(const sid of staffIds) staffCounts[sid]=(staffCounts[sid]||0)+qty;

        const line=(Number(it.price)||0)*qty;
        const share=staffIds.length ? (line/staffIds.length) : 0;
        for(const sid of staffIds) staffSales[sid]=(staffSales[sid]||0)+share;
      }
    }
  }

  const totalServicesQty=Object.values(svcCounts).reduce((a,b)=>a+b,0);
  const commPct = FIXED_COMMISSION_PCT;

  const commissions = S.staff.map(st=>({
    sid: st.id,
    sales: staffSales[st.id]||0,
    comm: (staffSales[st.id]||0) * (commPct/100)
  }));

  return {invs,income,invCount,totalServicesQty,svcCounts,staffCounts,staffSales,commPct,commissions};
}

function renderStats(){
  const d=todayKey();
  const st=dayStats(d);
  $("kpiIncome").textContent=fmtKD(st.income);
  $("kpiInv").textContent=st.invCount;
  $("kpiServices").textContent=st.totalServicesQty;

  const svcRows = Object.entries(st.svcCounts).sort((a,b)=>b[1]-a[1]).map(([name,count])=>
    `<tr><td>${escapeHtml(name)}</td><td class="right"><b>${count}</b></td></tr>`
  ).join("");
  $("svcCounts").innerHTML = `
    <table>
      <thead><tr><th>Service â€¢ Ø§Ù„Ø®Ø¯Ù…Ø©</th><th class="right">Count â€¢ Ø§Ù„Ø¹Ø¯Ø¯</th></tr></thead>
      <tbody>${svcRows || `<tr><td colspan="2" class="tiny">No data</td></tr>`}</tbody>
    </table>
  `;

  const staffRows = S.staff.map(stf=>{
    const c=st.staffCounts[stf.id]||0;
    const sales=st.staffSales[stf.id]||0;
    const comm = sales*(FIXED_COMMISSION_PCT/100);
    return `
      <tr>
        <td><b>${escapeHtml(stf.name)}</b></td>
        <td class="right">${c}</td>
        <td class="right">${fmtKD(sales)}</td>
        <td class="right"><b>${fmtKD(comm)}</b></td>
      </tr>`;
  }).join("");
  $("staffCounts").innerHTML = `
    <table>
      <thead><tr>
        <th>Staff â€¢ Ø§Ù„Ù…ÙˆØ¸ÙØ©</th>
        <th class="right">Count â€¢ Ø§Ù„Ø¹Ø¯Ø¯</th>
        <th class="right">Sales KD â€¢ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
        <th class="right">Comm (3%) â€¢ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
      </tr></thead>
      <tbody>${staffRows || `<tr><td colspan="4" class="tiny">No staff</td></tr>`}</tbody>
    </table>
  `;
}

function renderToday(){
  const invs=invoicesByDate(todayKey()).sort((a,b)=>b.ts-a.ts);
  if(invs.length===0){ $("todayList").innerHTML=`<div class="tiny">No invoices today</div>`; return; }

  $("todayList").innerHTML = invs.map(inv=>{
    const msgLines = inv.items.map(it=>{
      if((it.price||0)===0) return `â€¢ ${it.name} Ã—${it.qty}`;
      return `â€¢ ${it.name} Ã—${it.qty} = ${fmtKD((it.price||0)*(it.qty||1))}KD`;
    });
    const msg =
`BH Invoice
Phone: ${inv.phone}
${msgLines.join("\n")}
Total: ${fmtKD(inv.total)} KD
Ø´ÙƒØ±Ø§ Ù„Ø²ÙŠØ§Ø±Ø© ØµØ§Ù„ÙˆÙ† bh`;

    const items = inv.items.map(it=>{
      const p=(it.price||0)*(it.qty||1);
      const staff=(it.staffIds||[]).map(staffName).join(", ")||"â€”";
      return `<div class="tiny">â€¢ <b>${escapeHtml(it.name)}</b> Ã—${it.qty} â€” ${fmtKD(p)}KD <span class="muted">(${escapeHtml(staff)})</span></div>`;
    }).join("");

    return `
      <div class="item">
        <div class="flex">
          <div>
            <div class="itemname">Phone: <span class="mono">${inv.phone}</span></div>
            <div class="tiny muted">${new Date(inv.ts).toLocaleTimeString()}</div>
          </div>
          <div class="row">
            <span class="pill">Total: <b>${fmtKD(inv.total)}</b> KD</span>
            <button class="btn mint smallbtn" onclick='openWA("${inv.phone}", ${JSON.stringify(msg)})'>
              <span class="bi"><span class="en">WhatsApp</span><span class="ar">ÙˆØ§ØªØ³Ø§Ø¨</span></span>
            </button>
          </div>
        </div>
        <div class="hr"></div>
        ${items}
      </div>`;
  }).join("");
}
window.openWA=openWA;

/* ===== Daily / Monthly report (Fixed 3%) ===== */
let lastDaily={text:"",html:""}, lastMonthly={text:"",html:""};

function openPrintWindow(title, html){
  const w = window.open("", "_blank");
  if(!w){ toast("Popup blocked"); return; }
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>${escapeHtml(title)}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;color:#111827;background:#fff}
    .card{border:1px solid rgba(17,24,39,.12);border-radius:16px;padding:14px}
    @media print { button{display:none!important} }
  </style></head><body>
  <button onclick="window.print()" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(17,24,39,.12);background:#111827;color:#fff;font-weight:900;cursor:pointer">
    Print / Save PDF
  </button>
  <div style="height:12px"></div>${html}</body></html>`);
  w.document.close();
}

function buildDaily(){
  const d=todayKey();
  const st=dayStats(d);

  const staffSummary = S.staff.map(s=>{
    const sales=st.staffSales[s.id]||0;
    const count=st.staffCounts[s.id]||0;
    const comm=sales*(FIXED_COMMISSION_PCT/100);
    return {name:s.name,count,sales,comm};
  });

  const totalComm=staffSummary.reduce((a,x)=>a+(x.comm||0),0);

  const invHtml = st.invs.map(inv=>{
    const itemHtml = inv.items.map(it=>{
      const staff=(it.staffIds||[]).map(staffName).join(", ")||"â€”";
      return `<div style="font-size:12px;color:#374151;margin:3px 0">â€¢ <b>${escapeHtml(it.name)}</b> Ã—${it.qty} â€” ${fmtKD((it.price||0)*(it.qty||1))}KD <span style="color:#6b7280">(${escapeHtml(staff)})</span></div>`;
    }).join("");
    return `<div style="border:1px solid rgba(17,24,39,.12);border-radius:14px;padding:10px;margin:10px 0;background:#fff">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div><b>Phone:</b> ${escapeHtml(inv.phone)} <span style="color:#6b7280;font-size:12px">(${new Date(inv.ts).toLocaleTimeString()})</span></div>
        <div><b>Total:</b> ${fmtKD(inv.total)} KD</div>
      </div>
      <div style="margin-top:6px">${itemHtml}</div>
    </div>`;
  }).join("");

  const staffRows=staffSummary.map(x=>`
    <tr>
      <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10)"><b>${escapeHtml(x.name)}</b></td>
      <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right">${x.count}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right">${fmtKD(x.sales)}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right"><b>${fmtKD(x.comm)}</b></td>
    </tr>`).join("");

  const html = `
    <div class="card">
      <h2>BH Daily Report â€¢ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ â€” ${d}</h2>
      <div>Income: <b>${fmtKD(st.income)}</b> KD â€¢ Invoices: <b>${st.invCount}</b></div>
      <div style="margin-top:6px">
        <b>Commission System:</b> Fixed ${FIXED_COMMISSION_PCT}% on staff sales
        <span style="color:#6b7280">â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨Øª ${FIXED_COMMISSION_PCT}Ùª Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ©</span>
      </div>
      <hr/>
      <h3>Invoices â€¢ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
      ${invHtml || `<div>No invoices</div>`}
      <hr/>
      <h3>Staff Summary â€¢ Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª</h3>
      <table style="width:100%;border-collapse:collapse;border:1px solid rgba(17,24,39,.12)">
        <thead style="background:rgba(17,24,39,.04)">
          <tr>
            <th style="padding:10px;text-align:left">Staff</th>
            <th style="padding:10px;text-align:right">Count</th>
            <th style="padding:10px;text-align:right">Sales</th>
            <th style="padding:10px;text-align:right">Commission (${FIXED_COMMISSION_PCT}%)</th>
          </tr>
        </thead>
        <tbody>${staffRows}</tbody>
      </table>
      <div style="margin-top:10px">Total Commission: <b>${fmtKD(totalComm)}</b> KD</div>
    </div>
  `;

  const textLines = staffSummary.map(x=>`${x.name}: Sales ${fmtKD(x.sales)}KD â€¢ Comm ${fmtKD(x.comm)}KD`).join("\n");

  const text =
`BH Daily Report â€” ${d}
Income: ${fmtKD(st.income)} KD
Invoices: ${st.invCount}

Commission System: Fixed ${FIXED_COMMISSION_PCT}% on staff sales
Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨Øª ${FIXED_COMMISSION_PCT}% Ø¹Ù„Ù‰ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ©

${textLines}

(Use PDF for full table)`;

  lastDaily={text,html};
  $("dailyPreview").innerHTML=html;
  toast("ØªÙ… / Built");
}

function buildMonthly(){
  const mk = $("monthSel").value;
  if(!mk){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ø´Ù‡Ø± / Pick month"); return; }

  const pct = FIXED_COMMISSION_PCT;

  const invs = S.invoices.filter(inv => inv.date.slice(0,7) === mk);

  const salesByStaff = {};
  for(const stf of S.staff) salesByStaff[stf.id] = 0;

  for(const inv of invs){
    for(const it of inv.items){
      const qty = Number(it.qty)||1;
      const staffIds = (it.staffIds||[]).filter(Boolean);
      if(!staffIds.length) continue;

      const line = (Number(it.price)||0) * qty;
      const share = line / staffIds.length;
      for(const sid of staffIds){
        salesByStaff[sid] = (salesByStaff[sid]||0) + share;
      }
    }
  }

  const rows = S.staff.map(stf=>{
    const sales = salesByStaff[stf.id] || 0;
    const comm = sales * (pct/100);
    return `
      <tr>
        <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10)"><b>${escapeHtml(stf.name)}</b></td>
        <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right">${fmtKD(sales)}</td>
        <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right">${fmtKD(pct)}</td>
        <td style="padding:8px;border-bottom:1px solid rgba(17,24,39,.10);text-align:right"><b>${fmtKD(comm)}</b></td>
      </tr>
    `;
  }).join("");

  const totalComm = S.staff.reduce((a,stf)=>{
    const sales = salesByStaff[stf.id]||0;
    return a + sales*(pct/100);
  }, 0);

  const html = `
    <div class="card">
      <h2>BH Monthly Commission â€¢ Ø¹Ù…ÙˆÙ„Ø§Øª â€” ${mk}</h2>
      <div>
        <b>Commission System:</b> Fixed ${pct}% on Total Staff Sales
        <span style="color:#6b7280">â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨Øª ${pct}Ùª Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ©</span>
      </div>
      <div style="margin-top:6px">Total Commission: <b>${fmtKD(totalComm)}</b> KD</div>
      <hr/>
      <table style="width:100%;border-collapse:collapse;border:1px solid rgba(17,24,39,.12)">
        <thead style="background:rgba(17,24,39,.04)">
          <tr>
            <th style="padding:10px;text-align:left">Staff â€¢ Ø§Ù„Ù…ÙˆØ¸ÙØ©</th>
            <th style="padding:10px;text-align:right">Sales â€¢ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
            <th style="padding:10px;text-align:right">%</th>
            <th style="padding:10px;text-align:right">Commission â€¢ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  const textLines = S.staff.map(stf=>{
    const sales = salesByStaff[stf.id]||0;
    const comm = sales*(pct/100);
    return `${stf.name}: Sales ${fmtKD(sales)}KD â€¢ Comm ${fmtKD(comm)}KD`;
  }).join("\n");

  const text =
`BH Monthly Commission â€” ${mk}
Commission System: Fixed ${pct}% on Total Staff Sales
Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: Ø«Ø§Ø¨Øª ${pct}% Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙØ©
Total Commission: ${fmtKD(totalComm)} KD

${textLines}

(Use PDF for full table.)`;

  lastMonthly = {text, html};
  $("monthlyPreview").innerHTML = html;
  toast("ØªÙ… / Built");
}

/* ===== Manage ===== */
function renderManageServices(){
  const list=$("manageServices");
  const cats=Array.from(new Set(S.services.map(s=>s.cat))).sort();
  const byCat={}; for(const c of cats) byCat[c]=[];
  for(const s of S.services) (byCat[s.cat]=byCat[s.cat]||[]).push(s);

  list.innerHTML=cats.map(c=>{
    const rows=(byCat[c]||[]).sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`
      <div class="item">
        <div class="flex">
          <div>
            <div class="itemname">${escapeHtml(s.name)}</div>
            <div class="tiny muted">Price: <b>${fmtKD(s.price)}</b> KD ${s.meta?.requiresStaffMin?`â€¢ Min Staff: ${s.meta.requiresStaffMin}`:""}</div>
          </div>
          <div class="row">
            <button class="btn purple smallbtn" onclick="editService('${s.id}')">Edit</button>
            <button class="btn pink smallbtn" onclick="deleteService('${s.id}')">Delete</button>
          </div>
        </div>
      </div>`).join("");
    return `<div style="margin-bottom:12px">
      <div class="row"><span class="pill"><b>${escapeHtml(c)}</b></span></div>
      <div style="margin-top:8px" class="items">${rows || `<div class="tiny">No services</div>`}</div>
    </div>`;
  }).join("");
}

function renderManageStaff(){
  const box=$("manageStaff");
  box.innerHTML = S.staff.map(s=>`
    <div class="item">
      <div class="flex">
        <div>
          <div class="itemname">${escapeHtml(s.name)}</div>
          <div class="tiny muted">ID: ${escapeHtml(s.id.slice(0,8))}â€¦</div>
        </div>
        <div class="row">
          <button class="btn purple smallbtn" onclick="editStaff('${s.id}')">Edit</button>
          <button class="btn pink smallbtn" onclick="deleteStaff('${s.id}')">Delete</button>
        </div>
      </div>
    </div>`).join("") || `<div class="tiny">No staff</div>`;
}

window.editService=(id)=>{
  const s=S.services.find(x=>x.id===id); if(!s) return;
  const name=prompt("Service name / Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:", s.name); if(name===null) return;
  const cat=prompt("Category / Ø§Ù„Ù‚Ø³Ù…:", s.cat); if(cat===null) return;
  const price=prompt("Price KD / Ø§Ù„Ø³Ø¹Ø±:", s.price); if(price===null) return;
  let minStaff=s.meta?.requiresStaffMin||0;
  const minStr=prompt("Min staff? 0 none / Ø£Ù‚Ù„ Ø¹Ø¯Ø¯ Ù…ÙˆØ¸ÙØ§Øª:", String(minStaff)); if(minStr===null) return;
  minStaff=Math.max(0, Number(minStr)||0);
  s.name=name.trim(); s.cat=cat.trim(); s.price=Number(price)||0;
  s.meta=s.meta||{};
  if(minStaff>0) s.meta.requiresStaffMin=minStaff; else delete s.meta.requiresStaffMin;
  persistAll(); renderAllPickers(); renderManageServices(); toast("ØªÙ… / Updated");
};
window.deleteService=(id)=>{
  if(!confirm("Delete service?")) return;
  S.services=S.services.filter(x=>x.id!==id);
  persistAll(); renderAllPickers(); renderManageServices(); toast("Deleted");
};
window.editStaff=(id)=>{
  const s=S.staff.find(x=>x.id===id); if(!s) return;
  const name=prompt("Staff name / Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØ©:", s.name); if(name===null) return;
  s.name=name.trim();
  persistAll(); renderStaffPicker(); renderManageStaff(); toast("ØªÙ… / Updated");
};
window.deleteStaff=(id)=>{
  if(!confirm("Delete staff?")) return;
  S.staff=S.staff.filter(x=>x.id!==id);
  persistAll(); renderStaffPicker(); renderManageStaff(); toast("Deleted");
};

function addServiceFlow(){
  const name=prompt("Service name / Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:"); if(!name) return;
  const cat=prompt("Category / Ø§Ù„Ù‚Ø³Ù…:", "Hair"); if(!cat) return;
  const price=prompt("Price KD / Ø§Ù„Ø³Ø¹Ø±:", "0"); if(price===null) return;
  const minStaff=prompt("Min staff? 0 none / Ø£Ù‚Ù„ Ø¹Ø¯Ø¯ Ù…ÙˆØ¸ÙØ§Øª:", "0"); if(minStaff===null) return;

  const svc={id:uid(),name:name.trim(),cat:cat.trim(),price:Number(price)||0};
  const ms=Math.max(0, Number(minStaff)||0);
  if(ms>0) svc.meta={requiresStaffMin:ms};
  S.services.push(svc);
  persistAll(); renderAllPickers(); renderManageServices(); toast("Added");
}
function addStaffFlow(){
  const name=prompt("Staff name / Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙØ©:"); if(!name) return;
  S.staff.push({id:uid(),name:name.trim()});
  persistAll(); renderStaffPicker(); renderManageStaff(); toast("Added");
}

/* ===== Pickers ===== */
function renderStaffPicker(){
  $("staffPick").innerHTML = S.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
}
functin renderCatServicePickers(){
  const cats=Array.from(new Set(S.services.map(s=>s.cat))).sort();
  $("catSel").innerHTML = cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  function renderSvcs(){
    const cat=$("catSel").value;
    const svcs=S.services.filter(s=>s.cat===cat).sort((a,b)=>a.name.localeCompare(b.name));
    $("svcSel").
